<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Register Your Face</title>
		<style>
			body {
				margin: 0;
				padding: 16px;
				font-family: Arial, sans-serif;
				display: flex;
				flex-direction: column;
				align-items: center;
				background: #f9f9f9;
				min-height: 100vh;
			}
			h1 {
				margin-bottom: 24px;
			}
			.controls {
				width: 100%;
				max-width: 400px;
				display: flex;
				flex-direction: column;
				gap: 12px;
				margin-bottom: 24px;
			}
			.controls input {
				padding: 12px;
				font-size: 1rem;
				width: 100%;
			}
			#regProgress {
				width: 100%;
				height: 16px;
			}
			#progressText {
				text-align: center;
				font-size: 0.9rem;
				margin-bottom: 16px;
			}
			#registrationMessage {
				text-align: center;
				color: red;
				min-height: 1.2em;
				margin-bottom: 16px;
			}
			video {
				width: 100%;
				max-width: 640px;
				aspect-ratio: 4/3;
				background-color: #000;
			}
		</style>
		<script src="./js/face-api.min.js"></script>
		<script src="./js/faceapi_warmup.js"></script>
	</head>
	<body>
		<h1>Register Your Face</h1>
		<div class="controls">
			<input type="text" id="userIdInput" placeholder="User ID">
			<input type="text" id="userNameInput" placeholder="User Name">
			<progress id="regProgress" max="20" value="0"></progress>
			<div id="progressText">0/20</div>
			<div id="registrationMessage"></div>
		</div>
		<video id="video" autoplay playsinline muted></video>
		<script>
			// Set registration mode and warmup callbacks
			var faceapi_action = "register";
			var warmup_completed = [camera_start, video_face_detection];
			// Configure detection options
			var face_detector_options_setup = {
				inputSize: 128,
				scoreThreshold: 0.75,
				maxDetectedFaces: 1
			};
			// Show feedback messages
			function showMessage(type, text) {
				const el = document.getElementById('registrationMessage');
				if (el) {
					el.innerText = text;
					el.style.color = type === 'error' ? 'red' : 'green';
				}
			}
			// Update progress bar and text
			function updateProgress() {
				const val = window.currentUserDescriptors ? window.currentUserDescriptors.length : 0;
				const max = window.maxCaptures;
				document.getElementById('regProgress').value = val;
				document.getElementById('progressText').innerText = `${val}/${max}`;
			}
			// Hook into the registration process to update progress
			const originalRegister = faceapi_register;
			faceapi_register = function(descriptor) {
				originalRegister(descriptor);
				updateProgress();
			};
			// Prefill input fields from URL parameters
			function getParam(name) {
				return new URLSearchParams(window.location.search).get(name) || '';
			}
			document.addEventListener('DOMContentLoaded', () => {
				document.getElementById('userIdInput').value = getParam('userid');
				document.getElementById('userNameInput').value = getParam('username');
				updateProgress();
				// Start camera preview immediately
				camera_start();
			});
		</script>
	</body>
</html>
